<!--
 date: 04/01/2018
 author: Andre' Neto

 copyright: Copyright 2017 F4E | European Joint Undertaking for ITER and
 the Development of Fusion Energy ('Fusion for Energy').
 Licensed under the EUPL, Version 1.1 or - as soon they will be approved
 by the European Commission - subsequent versions of the EUPL (the "Licence")
 You may not use this work except in compliance with the Licence.
 You may obtain a copy of the Licence at: http://ec.europa.eu/idabc/eupl

 warning: Unless required by applicable law or agreed to in writing,
 software distributed under the Licence is distributed on an "AS IS"
 basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 or implied. See the Licence permissions and limitations under the Licence.
-->

<html>
    <head>
        <!-- Standard imports -->

        <!-- Project imports -->
        <link rel="import" href="/libraries.html">
        <link rel="import" href="/htk-component.html">
    </head>
    <body>
        <!-- HTML5 component template-->
        <template id="tfilter">
            <style>
                @import url("/js/jqmath-0.4.3.css");
            </style>
            <input type="range" id="trange" min="1000" max="100000" value="10000" background="#4CAF50" border="1">
            <input type="text" id="tinput"></input>
            <canvas width="600" height="300" id="tcanvas"></canvas>
        </template>
        <script>
        //This is enclosure is required to protect the importDoc
        (function () {
            var importDoc = document.currentScript.ownerDocument; // importee

            /**
             * @brief A simple filter editor where the user is allowed to specify the zeros and the poles of the filter. The transfer function is plot using chartjs.
             * @details In this implementation the data type is assumed to be a 2d array where the transfer function numerator is the first row of the array ([0][i]) and the denominator the second row of the array ([1][i]).
             */
            class HtkHvpsPlotEditor extends HtkComponent {

                /**
                 * @brief Constructor. NOOP.
                 */
                constructor () {
                    super();
                }


				domLoaded(){

                    var varName="data-ru";
	            	var varNameId=this.getAttribute(varName);
    	            var htkCompArray = document._frameComponents[varNameId];
        	        this.ru=htkCompArray[0];

                    this.ru.setUpdateValFun(this, 0);
                    this.ru.setReadOnly(false);

                    var varName="data-v";
	            	var varNameId=this.getAttribute(varName);
    	            var htkCompArray = document._frameComponents[varNameId];
        	        this.v=htkCompArray[0];

                    this.v.setUpdateValFun(this, 1);
                    this.v.setReadOnly(false);

                    var varName="data-rd";
	            	var varNameId=this.getAttribute(varName);
    	            var htkCompArray = document._frameComponents[varNameId];
        	        this.rd=htkCompArray[0];

                    this.rd.setUpdateValFun(this, 2);
                    this.rd.setReadOnly(false);


                    var varName="data-pl";
	            	var varNameId=this.getAttribute(varName);
    	            var htkCompArray = document._frameComponents[varNameId];
        	        this.pl=htkCompArray[0];

                    this.pl.setUpdateValFun(this, 3);
                    this.pl.setReadOnly(false);

                    var varName="data-pl-unit";
	            	var varNameId=this.getAttribute(varName);
    	            var htkCompArray = document._frameComponents[varNameId];
        	        this.plInSec=htkCompArray[0];

                    this.plInSec.setUpdateValFun(this, 4);
                    this.plInSec.setReadOnly(false);



                    this.rangeInput = this.shadowRoot.querySelector("#tinput");
                    this.rangeInput.contentEditable="true";
                    this.rangeInput.disabled = false;


                    this.rangeSlider = this.shadowRoot.querySelector("#trange");
                    this.rangeSlider.onclick = function() {
                    	this.value=this.rangeSlider.value;
                    	this.rangeInput.value=this.value.toString();
      			        this.updateValue(true, 0);
                    }.bind(this);

                    this.rangeInput.addEventListener("input", function (e) {
                    	this.value=this.rangeInput.value;
                    	this.rangeSlider.value=this.value;
      			        this.updateValue(true, 0);
                    }.bind(this));

				}

                /**
                 * @brief Checks if the plot should be updated due to a value change (of the component itself or from the reference).
                 * @param[in] userChanged true if the value update was triggered by a user action.
                 */

                updateValue(userChanged, caller){
					this.variablesInfoLoaded();
                }




				scheduleChanged(x){
					this.variablesInfoLoaded();
				}


				variablesInfoLoaded(){
                    this.rangeSlider.value=this.value;
                   	this.rangeInput.value=this.value.toString();

                   	var plValue=parseFloat(this.pl.value);
                   	if(this.plInSec.value>0){
                   		plValue*=1000.0;
                   	}

                	var times=[0, plValue-(parseFloat(this.rd.value)/1000.0)];
                	var ruTimes=[parseFloat(this.ru.value)/1000.0, parseFloat(this.rd.value)/1000.0];
                	var voltag=[parseFloat(this.v.value), 0];


                   	var plRefValue=parseFloat(this.pl.referenceValue);
                   	if(this.plInSec.referenceValue>0){
                   		plRefValue*=1000.0;
                   	}

                	var timesRef=[0, plRefValue-(parseFloat(this.rd.referenceValue)/1000.0)];
                	var ruTimesRef=[parseFloat(this.ru.referenceValue)/1000.0, (this.rd.referenceValue)/1000.0];
                	var voltagRef=[parseFloat(this.v.referenceValue),  0];

                   	var plPlantValue=parseFloat(this.pl.plantValue);
                   	if(this.plInSec.plantValue>0){
                   		plPlantValue*=1000.0;
                   	}

                	var timesPlant=[0, plPlantValue-(parseFloat(this.rd.plantValue)/1000.0)];
                	var ruTimesPlant=[parseFloat(this.ru.plantValue)/1000.0, parseFloat(this.rd.plantValue)/1000.0];
                	var voltagPlant=[parseFloat(this.v.plantValue), 0];


	                this.chart.data.datasets[0].data = this.compute(times,ruTimes,voltag, plValue);
	                this.chart.data.datasets[1].data = this.compute(timesRef,ruTimesRef,voltagRef, plRefValue);
	                this.chart.data.datasets[2].data = this.compute(timesPlant,ruTimesPlant,voltagPlant, plPlantValue);

	                this.chart.update();

				}


                /**
                 * @brief Gets the transfer function filter response by evaluating the function for N frequencyStep and up to the selected maxFrequency.
                 * @param[in] num the transfer function numerator polynomial.
                 * @param[in] den the transfer function denominator polynomial.
                 */
                compute(t, ru, v, pl) {

                	var lengthX=pl;
                	var nPoints=this.value;
                	var yOut=[];
                	var tLength=t.length;

                	var dt=pl/nPoints;

                	var tr=0;
                	var v_1=0;
                	yOut[0]={x: 0, y: 0};
                	var n=0;
                	var time=dt;
               		for(var k=1; k<nPoints; k++){
						if(time>tr && time<t[n]){
							yOut[k]={x: time, y: yOut[k-1].y};
							time+=dt;
						}
						else{
							tr=t[n]+ru[n];
							if((time>=t[n]) && (time<tr)){
								yOut[k]={x: time, y: yOut[k-1].y+((v[n]-v_1)/ru[n])*dt};
								time+=dt;
								if(time>=tr){
									yOut[k]={x: time, y: v[n]};
									v_1=v[n];
									n++;
								}
							}
						}
					}
					return yOut;
                }


                    getTheCorrectValue(valueToSet){
                		if (Array.isArray(valueToSet)) {
                    		return valueToSet[0];
                    	}
                    	else{
                    		return valueToSet;
                    	}

                    }


                    setValue (valueToSet, updateRemote = true) {
                   		this.value=this.getTheCorrectValue(valueToSet);
            			this.fireValueChanged(HtkComponent.VALUE_CHANGED);
            			if (updateRemote) {
                			this.updateRemote(valueToSet);
            			}
           				this.refresh();
                    }


			        setReference (referenceToSet) {
                   		this.referenceValue=this.getTheCorrectValue(referenceToSet);
            			this.refresh();
        			}

       			    setPlantValue (plantValueToSet) {
                      	this.plantValue=this.getTheCorrectValue(plantValueToSet);
            			this.fireValueChanged(HtkComponent.VALUE_CHANGED);
           				this.refresh();
	                }


                /**
                 * @brief Calls checkValues
                 */
                refresh() {
                }

                /**
                 * @brief See HtkComponent.getTemplate
                 */
                getTemplate() {
                    var template = importDoc.querySelector("#tfilter");
                    return template;
                }

                /**
                 * @brief See HtkComponent.createdCallback
                 */
                createdCallback () {
                    super.createdCallback();
					parent.htkHelper.addVariablesInfoLoadedListener(this);
					parent.htkHelper.addScheduleChangedListener(this);
                }

                /**
                 * @brief See HtkComponent.attachedCallback.
                 */
                attachedCallback () {
                    super.attachedCallback();
                    var ctx = this.shadowRoot.querySelector("#tcanvas");
                    var chart = new Chart(ctx, {
                        // The type of chart we want to create
                        type: "line",

                        // The data for our dataset
                        data: {
                            datasets: [
                            {
                                label: "Current",
                                fill: "false",
                                backgroundColor: "white",
                                borderColor: "blue", // The main line color
                                borderWidth: 2,
								pointRadius: 0
                            },
                            {
                                label: "Reference",
                                fill: "false",
                                backgroundColor: "white",
                                borderColor: "gray",
                                borderWidth: 2,
								pointRadius: 0
                            },
                            {
                                label: "Plant",
                                fill: "false",
                                backgroundColor: "white",
                                borderColor: "red",
                                borderWidth: 2,
								pointRadius: 0
                            }]
                        },

                        // Configuration options go here
                        options: {
                            scales: {
                                xAxes: [{
                                    type: "linear",
                                    scaleLabel: {
                                        display: true,
                                        labelString: "Time"
                                    }
                                }],
                                yAxes: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: "Voltage"
                                    }
                                }]
                            },
                            responsive : false
                        }
                    });
                    this.chart = chart;
                }
            }

            /**
             * @brief Registers the element.
             */
            document.registerElement("htk-hvps-plot-editor", {
                prototype: HtkHvpsPlotEditor.prototype
            });

       })();
        </script>
   </body>
</html>
